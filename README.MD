# Backend - Sistema de Emiss√£o de Notas Fiscais (Desafio Korp)

Este √© o backend do desafio t√©cnico, focado na implementa√ß√£o de um sistema de emiss√£o de notas fiscais utilizando uma arquitetura de microsservi√ßos. O projeto foi desenvolvido em C# com .NET, priorizando a resili√™ncia, concorr√™ncia e boas pr√°ticas de design.

## üèõÔ∏è Arquitetura

O cora√ß√£o do projeto √© uma arquitetura de microsservi√ßos desacoplada e orientada a eventos, usando o padr√£o *Saga* para comunica√ß√£o ass√≠ncrona.



O sistema √© dividido em dois servi√ßos principais:

1.  **üì¶ Korp.Estoque**:
    * Respons√°vel pelo CRUD de Produtos e controle de saldo.
    * Funciona como o "receptor" no fluxo de impress√£o, consumindo eventos do RabbitMQ para dar baixa no estoque.

2.  **üßæ Korp.Faturamento**:
    * Respons√°vel pelo CRUD de Notas Fiscais.
    * Inicia o fluxo de impress√£o, atuando como o "publicador" de eventos.
    * Ouve os eventos de resposta (sucesso ou falha) para finalizar o status da nota.

Essa abordagem garante o **tratamento de falhas** : se o servi√ßo de Estoque estiver offline, as solicita√ß√µes de impress√£o ficar√£o na fila do RabbitMQ e ser√£o processadas assim que o servi√ßo voltar, sem perda de dados.

---

## ‚ú® Features Implementadas

Al√©m dos requisitos b√°sicos, o projeto implementa dois dos requisitos opcionais para demonstrar robustez.

* **CRUD de Produtos:** Cria√ß√£o e listagem de produtos com seus respectivos saldos.
* **CRUD de Notas Fiscais:**  Cria√ß√£o de notas com status inicial "Aberta" e numera√ß√£o sequencial.
* **Fluxo de Impress√£o Ass√≠ncrono:**  Endpoint que inicia o processo de "impress√£o", mudando o status da nota e atualizando o saldo.
* **Resili√™ncia e Tratamento de Falhas:**  O uso de RabbitMQ garante que o sistema se recupere de falhas.
* **‚úÖ (Opcional) Implementa√ß√£o de Idempot√™ncia:**  O endpoint `.../imprimir` usa um header `X-Idempotency-Key` para garantir que requisi√ß√µes duplicadas n√£o causem efeitos colaterais (como dar baixa no estoque duas vezes).
* **‚úÖ (Opcional) Tratamento de Concorr√™ncia:** O servi√ßo de Estoque usa `RowVersion` (Timestamp) no EF Core para detectar e tratar ativamente conflitos de concorr√™ncia (cen√°rio onde duas notas tentam usar o √∫ltimo item do estoque ao mesmo tempo).

---

## üõ†Ô∏è Tecnologias Utilizadas

* **.NET 8** (C#)
* **ASP.NET Core** (para as Web APIs)
* **Entity Framework Core** (para acesso a dados)
* **Docker** (para rodar os servi√ßos de infraestrutura)
* **SQL Server** (rodando em Docker, com bancos separados)
* **RabbitMQ** (rodando em Docker, para mensageria)
* **MassTransit** (Abstra√ß√£o de alto n√≠vel para RabbitMQ em .NET)
* **Swagger/OpenAPI** (para documenta√ß√£o de API)

---

## üèÅ Como Rodar o Projeto

Voc√™ precisar√° do **.NET 8 SDK** e do **Docker Desktop** instalados.

### 1. Iniciar a Infraestrutura (Docker)

Os servi√ßos de banco de dados e mensageria rodam em containers.

```bash
# 1. Inicie o SQL Server (lembre-se de usar sua senha)
docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=SuaSenhaForteAqui" -p 1433:1433 --name korp-sql-server -d [mcr.microsoft.com/mssql/server:2022-latest](https://mcr.microsoft.com/mssql/server:2022-latest)

# 2. Inicie o RabbitMQ (com o painel de gerenciamento)
docker run -d --hostname my-rabbit --name korp-rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
```

## 2 - Preparar os Bancos de Dados (Migrations)

Execute as migrations do EF Core para cada servi√ßo (em terminais separados).

```bash
# Terminal 1: Korp.Estoque
cd src/Korp.Estoque
dotnet ef database update

# Terminal 2: Korp.Faturamento
cd src/Korp.Faturamento
dotnet ef database update
```
## 3 - Rodar as APIs

```bash
# Terminal 1: Korp.Estoque
cd src/Korp.Estoque
dotnet run

# Terminal 2: Korp.Faturamento
cd src/Korp.Faturamento
dotnet run
```

## Testes

### rotas da aplica√ß√£o para testes:

1. Korp.Estoque - Swagger: https://localhost:5274/swagger
2. Korp.Faturamento Swagger: https://localhost:7005/swagger


# üíªFrontend 

A interface foi desenvolvida em Angular, atendendo ao requisito principal do desafio. O projeto utiliza a abordagem de Standalone Components para uma arquitetura mais leve e moderna.

### üõ†Ô∏è Tecnologias e Bibliotecas
* Angular 17+: Framework principal.
* Angular Material: Utilizado como biblioteca de componentes visuais para garantir uma UI consistente e responsiva (uso de MatTable, MatCard, MatSnackBar, etc.).
* RxJS: Utilizado para o gerenciamento de chamadas ass√≠ncronas e reatividade na comunica√ß√£o com as APIs de Estoque e Faturamento.
* UUID: Biblioteca utilizada para gerar identificadores √∫nicos (GUIDs) no frontend, permitindo o envio do header X-Idempotency-Key para garantir a idempot√™ncia nas opera√ß√µes de impress√£o.

### ‚ú® Funcionalidades no Frontend
* Gest√£o de Estoque: Formul√°rio para cadastro de produtos e listagem com visualiza√ß√£o de saldo em tempo real.
* Emiss√£o de Notas: Interface para cria√ß√£o de notas fiscais com m√∫ltiplos itens.
* Bot√£o de Impress√£o Inteligente: Bot√£o vis√≠vel e intuitivo que dispara o processo ass√≠ncrono.
* Exibe indicador de processamento (Spinner) durante a requisi√ß√£o.
* Utiliza MatSnackBar (Toast) para feedback n√£o-bloqueante de sucesso ou erro.
* Bloqueia a reimpress√£o de notas que n√£o estejam com status "Aberta".

### üöÄ Como Rodar o Frontend (Modo Desenvolvimento)
```shell
cd frontend
npm install
```

```shell
ng serve
```

O projeto estar√° dispon√≠vel em http://localhost:4200

## üê≥ Rodando Tudo com Docker 

### 1. Na raiz do projeto, crie um arquivo .env com a senha do banco:
```
DB_PASSWORD=SuaSenhaForteAqui!
```

### 2. Execute o comando de build e start:
```
docker-compose up --build
```