# Backend - Sistema de Emiss√£o de Notas Fiscais (Desafio Korp)

[cite_start]Este √© o backend do desafio t√©cnico[cite: 2], focado na implementa√ß√£o de um sistema de emiss√£o de notas fiscais utilizando uma arquitetura de microsservi√ßos. O projeto foi desenvolvido em C# com .NET, priorizando a resili√™ncia, concorr√™ncia e boas pr√°ticas de design.

## üèõÔ∏è Arquitetura

[cite_start]O cora√ß√£o do projeto √© uma arquitetura de microsservi√ßos [cite: 40] desacoplada e orientada a eventos, usando o padr√£o *Saga* para comunica√ß√£o ass√≠ncrona.



[cite_start]O sistema √© dividido em dois servi√ßos principais[cite: 41]:

1.  **üì¶ Korp.Estoque**:
    * [cite_start]Respons√°vel pelo CRUD de Produtos e controle de saldo[cite: 42].
    * Funciona como o "receptor" no fluxo de impress√£o, consumindo eventos do RabbitMQ para dar baixa no estoque.

2.  **üßæ Korp.Faturamento**:
    * [cite_start]Respons√°vel pelo CRUD de Notas Fiscais[cite: 42].
    * Inicia o fluxo de impress√£o, atuando como o "publicador" de eventos.
    * Ouve os eventos de resposta (sucesso ou falha) para finalizar o status da nota.

[cite_start]Essa abordagem garante o **tratamento de falhas** [cite: 43][cite_start]: se o servi√ßo de Estoque estiver offline, as solicita√ß√µes de impress√£o ficar√£o na fila do RabbitMQ e ser√£o processadas assim que o servi√ßo voltar, sem perda de dados[cite: 45].

---

## ‚ú® Features Implementadas

Al√©m dos requisitos b√°sicos, o projeto implementa dois dos requisitos opcionais para demonstrar robustez.

* [cite_start]**CRUD de Produtos:** [cite: 19] Cria√ß√£o e listagem de produtos com seus respectivos saldos.
* [cite_start]**CRUD de Notas Fiscais:** [cite: 25] Cria√ß√£o de notas com status inicial "Aberta" e numera√ß√£o sequencial.
* [cite_start]**Fluxo de Impress√£o Ass√≠ncrono:** [cite: 31] [cite_start]Endpoint que inicia o processo de "impress√£o", mudando o status da nota [cite: 35] [cite_start]e atualizando o saldo[cite: 37].
* [cite_start]**Resili√™ncia e Tratamento de Falhas:** [cite: 43] O uso de RabbitMQ garante que o sistema se recupere de falhas.
* [cite_start]**‚úÖ (Opcional) Implementa√ß√£o de Idempot√™ncia:** [cite: 52] [cite_start]O endpoint `.../imprimir` usa um header `X-Idempotency-Key` para garantir que requisi√ß√µes duplicadas n√£o causem efeitos colaterais (como dar baixa no estoque duas vezes)[cite: 53].
* [cite_start]**‚úÖ (Opcional) Tratamento de Concorr√™ncia:** [cite: 48] [cite_start]O servi√ßo de Estoque usa `RowVersion` (Timestamp) no EF Core para detectar e tratar ativamente conflitos de concorr√™ncia (cen√°rio onde duas notas tentam usar o √∫ltimo item do estoque ao mesmo tempo)[cite: 49].

---

## üõ†Ô∏è Tecnologias Utilizadas

* **.NET 8** (C#)
* **ASP.NET Core** (para as Web APIs)
* **Entity Framework Core** (para acesso a dados)
* **Docker** (para rodar os servi√ßos de infraestrutura)
* **SQL Server** (rodando em Docker, com bancos separados)
* **RabbitMQ** (rodando em Docker, para mensageria)
* **MassTransit** (Abstra√ß√£o de alto n√≠vel para RabbitMQ em .NET)
* **Swagger/OpenAPI** (para documenta√ß√£o de API)

---

## üèÅ Como Rodar o Projeto

Voc√™ precisar√° do **.NET 8 SDK** e do **Docker Desktop** instalados.

### 1. Iniciar a Infraestrutura (Docker)

Os servi√ßos de banco de dados e mensageria rodam em containers.

```bash
# 1. Inicie o SQL Server (lembre-se de usar sua senha)
docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=SuaSenhaForteAqui" -p 1433:1433 --name korp-sql-server -d [mcr.microsoft.com/mssql/server:2022-latest](https://mcr.microsoft.com/mssql/server:2022-latest)

# 2. Inicie o RabbitMQ (com o painel de gerenciamento)
docker run -d --hostname my-rabbit --name korp-rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
```

## 2 - Preparar os Bancos de Dados (Migrations)

Execute as migrations do EF Core para cada servi√ßo (em terminais separados).

```bash
# Terminal 1: Korp.Estoque
cd src/Korp.Estoque
dotnet ef database update

# Terminal 2: Korp.Faturamento
cd src/Korp.Faturamento
dotnet ef database update
```
## 3 - Rodar as APIs

```bash
# Terminal 1: Korp.Estoque
cd src/Korp.Estoque
dotnet run

# Terminal 2: Korp.Faturamento
cd src/Korp.Faturamento
dotnet run
```

## Testes

### rotas da aplica√ß√£o para testes:

1. Korp.Estoque - Swagger: https://localhost:<porta_estoque>/swagger
2. Korp.Faturamento Swagger: https://localhost:<porta_faturamento>/swagger